{% extends "surveys/base.html" %}

{% block title %}Estadísticas de {{ survey.name }}{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow mb-8">
  <h2 class="text-xl font-semibold mb-4">Filtrar por Fecha</h2>
  <form method="get" action="">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label for="start_date" class="block text-sm font-medium text-gray-700">Fecha de Inicio</label>
        <input type="date" name="start_date" id="start_date" value="{{ start_date|default:'' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      </div>
      <div>
        <label for="end_date" class="block text-sm font-medium text-gray-700">Fecha de Fin</label>
        <input type="date" name="end_date" id="end_date" value="{{ end_date|default:'' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      </div>
      <div class="self-end">
        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Filtrar</button>
      </div>
    </div>
  </form>
</div>

<div class="bg-white p-6 rounded-lg shadow mb-8">
  <h2 class="text-xl font-semibold mb-4">Ejecución por Día</h2>
  <canvas id="dailyExecutionChart"></canvas>
</div>

<script>
  const ctx = document.getElementById('dailyExecutionChart');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        label: 'Número de Encuestas',
        data: {{ chart_data|safe }},
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
</script>

<div class="mb-6">
  <h1 class="text-2xl font-bold">{{ survey.name }}</h1>
  <p class="text-lg text-gray-600">Estadísticas de la Encuesta</p>
</div>

<div class="bg-white p-6 rounded-lg shadow mb-8">
  <div class="flex justify-between items-center">
    <h2 class="text-xl font-semibold">Resumen General</h2>
    <a href="{% url 'surveys:export_excel' survey_code=survey.code %}" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
        Exportar a Excel
    </a>
</div>
  <p class="mt-2">Número total de respuestas: <span class="font-bold text-blue-600">{{ response_count }}</span></p>

  <div class="mt-4">
    <h3 class="text-lg font-semibold">Respuestas por Encuestador</h3>
    <div class="overflow-x-auto mt-2">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Encuestador</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nº Respuestas</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for item in interviewer_response_counts %}
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.interviewer__full_name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">{{ item.count }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">No hay respuestas de encuestadores para esta encuesta.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="space-y-6">
  {% for question_stat in stats_data %}
    <div class="bg-white p-6 rounded-lg shadow">
      <h3 class="font-semibold text-lg">{{ question_stat.text }}</h3>
      <span class="text-xs font-mono bg-gray-100 text-gray-600 px-2 py-1 rounded">Tipo: {{ question_stat.type }}</span>

      <div class="mt-4">
        {% if question_stat.type == 'single' or question_stat.type == 'multi' or question_stat.type == 'likert' %}
          {% with stats=question_stat.data %}
            <p class="text-sm text-gray-500 mb-3">Total de votos: {{ stats.total_votes }}</p>
            <div class="space-y-2">
              {% for option in stats.options %}
                <div>
                  <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">{{ option.label }} ({{ option.count }} votos)</span>
                    <span class="text-sm font-medium text-gray-500">{{ option.percentage }}%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ option.percentage }}%"></div>
                  </div>
                </div>
              {% empty %}
                <p class="text-sm text-gray-500">Aún no hay respuestas para esta pregunta.</p>
              {% endfor %}
            </div>
          {% endwith %}
        {% elif question_stat.type == 'int' or question_stat.type == 'dec' %}
          {% with stats=question_stat.data %}
            <div class="grid grid-cols-3 gap-4 text-center">
              <div>
                <p class="text-sm text-gray-500">Promedio</p>
                <p class="text-xl font-bold">{{ stats.avg|default:"N/A" }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Mínimo</p>
                <p class="text-xl font-bold">{{ stats.min|default:"N/A" }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Máximo</p>
                <p class="text-xl font-bold">{{ stats.max|default:"N/A" }}</p>
              </div>
            </div>
          {% endwith %}
        {% elif question_stat.type == 'bool' %}
          {% with stats=question_stat.data %}
            <div class="flex space-x-4">
              <p>Sí: <span class="font-bold">{{ stats.true }}</span></p>
              <p>No: <span class="font-bold">{{ stats.false }}</span></p>
            </div>
          {% endwith %}
        {% else %}
          <p class="text-sm text-gray-500">No hay visualización de estadísticas para este tipo de pregunta.</p>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<div class="mt-8">
    <a href="{% url 'surveys:list' %}" class="text-blue-600 hover:underline">&larr; Volver a la lista de encuestas</a>
</div>



{% endblock %}
