{% extends "surveys/base.html" %}
{% block title %}{{ survey.name }}{% endblock %}
{% block content %}
<div id="dataProtectionSection" class="bg-white p-6 rounded-xl shadow-md mb-6">
    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Cláusula de Protección de Datos</h2>

    {% if consent_error %}
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
      <p class="font-bold">Error</p>
      <p>{{ consent_error }}</p>
    </div>
    {% endif %}

    <p class="text-gray-700 mb-4 text-justify">
        {{ data_protection_clause_text }}
        <a href="{{ MEDIA_URL }}CONSENTIMIENTO INFORMADO Y AUTORIZACIÓN DE TRATAMIENTO DE DATOS.pdf" target="_blank" class="text-blue-600 hover:underline"> 
          Leer consentimiento informado y autorización de tratamiento de datos. 
        </a>
    </p>
    
    <div class="flex space-x-4 mb-6">
        <div class="flex items-center">
            <input type="radio" id="acceptDataProtectionYes" name="data_protection_consent" value="yes" class="form-radio h-4 w-4 text-blue-600 transition duration-150 ease-in-out">
            <label for="acceptDataProtectionYes" class="ml-2 block text-sm leading-5 text-gray-900">
                Si
            </label>
        </div>
        <div class="flex items-center">
            <input type="radio" id="acceptDataProtectionNo" name="data_protection_consent" value="no" class="form-radio h-4 w-4 text-red-600 transition duration-150 ease-in-out">
            <label for="acceptDataProtectionNo" class="ml-2 block text-sm leading-5 text-gray-900">
                No
            </label>
        </div>
    </div>
    <button type="button" id="continueToSurvey" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors" disabled>Continuar</button>
</div>

<div id="surveyContentWrapper" style="display: none;">

<style>
  .radio-options-inline > div, .checkbox-options-inline > div {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }
  .radio-options-inline > div > div, .checkbox-options-inline > div > div {
    display: flex;
    align-items: center;
    background-color: #fff;
    border: 1px solid #e2e8f0;
    padding: 1rem;
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  }
  .radio-options-inline > div > div:hover, .checkbox-options-inline > div > div:hover {
    border-color: #3b82f6;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  .radio-options-inline input[type="radio"], .checkbox-options-inline input[type="checkbox"] {
    margin-right: 0.75rem;
    accent-color: #3b82f6;
    height: 1.25rem;
    width: 1.25rem;
  }
  /* Style for selected option */
  .radio-options-inline > div > div.selected, .checkbox-options-inline > div > div.selected {
    border-color: #3b82f6;
    background-color: #eff6ff;
    color: #1e40af;
  }
</style>

{% load static %}
<img src="{% static 'surveys/images/logo.png' %}" alt="Logo" class="h-24 mx-auto mb-4">
<h1 class="text-xl font-semibold mb-2 text-center">{{ survey.name }}</h1>
{% if survey.description %}
  <p class="text-gray-600 mb-6 text-center">{{ survey.description }}</p>
{% endif %}



<form method="post" class="space-y-6" data-check-url="{% url 'surveys:check_respondent' survey.code %}">{% csrf_token %}
  {% if is_respondent_step %}
  <!-- Paso 0: Datos encuestado -->
  <div class="step bg-white p-6 rounded-xl shadow-md">
    <h2 class="text-lg font-semibold mb-4 border-b pb-2">Datos del encuestado</h2>
    <input type="hidden" name="step_name" value="respondent">
    <div class="grid sm:grid-cols-2 gap-6">
      {% for f in respondent_form %}
        <div class="field" data-required="{{ f.field.required|yesno:'1,0' }}">
          <label class="block text-sm font-medium text-gray-700 mb-1">{{ f.label }}{% if f.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
          {{ f }}
          {% for e in f.errors %}<p class="text-xs text-red-600 mt-1">{{ e }}</p>{% endfor %}
          <p class="client-error text-xs text-red-600 mt-1 hidden"></p>
        </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <!-- Pasos siguientes: Secciones -->
  <!-- PROGRESO -->
  <div class="mb-6">
    <div class="flex items-center justify-between text-sm mb-2">
      <span id="stepText" class="font-medium">Sección {{ current_section_idx|add:1 }} de {{ total_sections }}: {{ section.title }}</span>
      <span id="percentText">0%</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2" aria-label="Progreso del formulario">
      <div id="progressBar" class="bg-blue-600 h-2 rounded-full" style="width:0%"></div>
    </div>
  </div>

  <div class="step bg-white p-6 rounded-xl shadow-md">
    <h2 class="text-lg font-semibold mb-4 border-b pb-2">Sección {{ current_section_idx|add:1 }}: {{ section.title }}</h2>
    
    <div class="grid sm:grid-cols-2 gap-6">
      {% for field in answers_form %}
        {% if field.field.question %}
        <div class="question-wrapper"
             data-question-id="{{ field.field.question.pk }}"
             {% if field.field.question.depends_on %}
             data-depends-on-question="{{ field.field.question.depends_on.pk }}"
             data-depends-on-option="{{ field.field.question.depends_on_option.pk|default_if_none:'' }}"
             data-depends-on-value-min="{{ field.field.question.depends_on_value_min|default_if_none:'' }}"
             data-depends-on-value-max="{{ field.field.question.depends_on_value_max|default_if_none:'' }}"
             style="display: none;"
            {% endif %}
             {% if field.field.trigger_code %}
             data-other-trigger="{{ field.field.trigger_code }}"
             {% endif %}>
            <div class="field" data-required="{{ field.field.required|yesno:'1,0' }}">
              <label class="block text-base font-medium text-gray-800 mb-3">{{ field.label }}{% if field.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
              <div class="{% if field.field.widget.input_type == 'radio' %}radio-options-inline{% endif %}">
                {{ field }}
              </div>
               {% if field.field.trigger_code %}
              <div class="other-text-wrapper mt-3" style="display: none;">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="question_{{ field.field.question.pk }}_other_text">{{ field.field.question.other_text_label }}</label>
                  <input type="text" name="question_{{ field.field.question.pk }}_other_text" id="question_{{ field.field.question.pk }}_other_text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
              </div>
              {% endif %}
              {% for e in field.errors %}<p class="text-xs text-red-600 mt-2">{{ e }}</p>{% endfor %}
              <p class="client-error text-xs text-red-600 mt-2 hidden"></p>
            </div>
        </div>
        {% else %}
            {# This handles fields that don't have a question object, like the ubicacion fields #}
            <div class="field" data-required="{{ field.field.required|yesno:'1,0' }}">
              <label class="block text-base font-medium text-gray-800 mb-3">{{ field.label }}{% if field.field.required %} <span class="text-red-500">*</span>{% endif %}</label>
              <div class="{% if field.field.widget.input_type == 'radio' %}radio-options-inline{% endif %}">
                {{ field }}
              </div>
              {% for e in field.errors %}<p class="text-xs text-red-600 mt-2">{{ e }}</p>{% endfor %}
              <p class="client-error text-xs text-red-600 mt-2 hidden"></p>
            </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="flex justify-between mt-8">
      <div>
          {% if previous_section_url %}
              <a href="{{ previous_section_url }}" class="px-6 py-2 rounded-lg bg-gray-300 text-gray-800 font-semibold hover:bg-gray-400 transition-colors">Anterior</a>
          {% endif %}
      </div>
      
      <div>
          {% if not is_respondent_step and current_section_idx == total_sections|add:-1 %}
              <button type="submit" id="submitBtn" class="px-6 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors">Enviar Encuesta</button>
          {% else %}
              <button type="submit" id="nextBtn" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors">Siguiente</button>
          {% endif %}
      </div>
  </div>
</form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const acceptYesRadio = document.getElementById('acceptDataProtectionYes');
    const acceptNoRadio = document.getElementById('acceptDataProtectionNo');
    const continueButton = document.getElementById('continueToSurvey');
    const dataProtectionSection = document.getElementById('dataProtectionSection');
    const surveyContentWrapper = document.getElementById('surveyContentWrapper');
    const consentError = "{{ consent_error|yesno:'true,false' }}";

    if (consentError === 'true') {
        sessionStorage.removeItem('surveyConsentGiven');
        dataProtectionSection.style.display = 'block';
        surveyContentWrapper.style.display = 'none';
    } else if (sessionStorage.getItem('surveyConsentGiven') === 'true') {
        dataProtectionSection.style.display = 'none';
        surveyContentWrapper.style.display = 'block';
    }

    {% if not is_respondent_step %}
    // Progress Bar Logic
    const progressBar = document.getElementById('progressBar');
    const percentText = document.getElementById('percentText');

    if (progressBar && percentText) {
        const currentSectionIdx = {{ current_section_idx }};
        const totalSections = {{ total_sections }};
        if (totalSections > 0) {
            const progressPercentage = Math.round(((currentSectionIdx + 1) / totalSections) * 100);
            progressBar.style.width = `${progressPercentage}%`;
            percentText.textContent = `${progressPercentage}%`;
        }
    }
    {% endif %}

    const mainForm = document.querySelector('form'); // Assuming the main survey form

    // Create a hidden input to store consent value
    const consentInput = document.createElement('input');
    consentInput.type = 'hidden';
    consentInput.name = 'data_protection_consent_value'; // Name for Django to pick up
    consentInput.value = ''; // Default to empty

    // Ensure mainForm exists before prepending
    if (mainForm) {
        mainForm.prepend(consentInput); // Add to the beginning of the form
    } else {
        console.error("Main form not found. Cannot add consent input.");
    }


    function updateContinueButtonState() {
        if (acceptYesRadio.checked) {
            continueButton.removeAttribute('disabled');
            consentInput.value = 'yes';
        } else if (acceptNoRadio.checked) {
            continueButton.setAttribute('disabled', 'disabled'); // Cannot continue if 'No' is selected
            consentInput.value = 'no';
        } else {
            continueButton.setAttribute('disabled', 'disabled');
            consentInput.value = '';
        }
    }

    acceptYesRadio.addEventListener('change', updateContinueButtonState);
    acceptNoRadio.addEventListener('change', updateContinueButtonState);

    continueButton.addEventListener('click', function() {
        if (acceptYesRadio.checked) {
            sessionStorage.setItem('surveyConsentGiven', 'true');
            dataProtectionSection.style.display = 'none';
            surveyContentWrapper.style.display = 'block';
            // Optionally, scroll to the top of the survey form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });

    // Initial state
    updateContinueButtonState();

    const form = document.querySelector("form");
    const checkUrl = form.dataset.checkUrl;
    const csrfTokenInput = form.querySelector('input[name="csrfmiddlewaretoken"]');

    function clearFieldError(field) {
        const fieldWrapper = field.closest('.field');
        if (!fieldWrapper) return;
        fieldWrapper.classList.remove("border", "border-red-300", "bg-red-50");
        const input = fieldWrapper.querySelector("input, textarea, select");
        if (input) input.classList.remove("ring-1", "ring-red-400", "border-red-400");
        const err = fieldWrapper.querySelector(".client-error");
        if (err) { err.textContent = ""; err.classList.add("hidden"); }
    }

    function setFieldError(field, msg) {
        const fieldWrapper = field.closest('.field');
        if (!fieldWrapper) return;
        fieldWrapper.classList.add("border", "border-red-300", "bg-red-50");
        const input = fieldWrapper.querySelector("input, textarea, select");
        if (input) input.classList.add("ring-1", "ring-red-400", "border-red-400");
        const err = fieldWrapper.querySelector(".client-error");
        if (err) { err.textContent = msg; err.classList.remove("hidden"); }
    }

    function validateFields(fields) {
        let valid = true;
        fields.forEach(field => {
            clearFieldError(field);
            const required = field.closest('.field').dataset.required === '1';
            if (!required) return;

            const inputs = field.querySelectorAll("input, textarea, select");
            if (!inputs.length) return;

            if (field.offsetParent === null) return; // Skip hidden fields

            const radios = field.querySelectorAll('input[type="radio"]');
            if (radios.length) {
                const name = radios[0].name;
                if (!form.querySelector(`input[type="radio"][name="${CSS.escape(name)}"]:checked`)) {
                    setFieldError(field, "Selecciona una opción.");
                    valid = false;
                }
                return;
            }

            const checks = field.querySelectorAll('input[type="checkbox"]');
            if (checks.length) {
                if (!Array.from(checks).some(c => c.checked)) {
                    setFieldError(field, "Selecciona al menos una opción.");
                    valid = false;
                }
                return;
            }

            inputs.forEach(input => {
                if (input.type === "hidden") return;
                if (!input.checkValidity() || (input.value || "").trim() === "") {
                    const label = field.closest('.field').querySelector("label")?.textContent?.replace("*","").trim() || "Este campo";
                    setFieldError(field, label + " es obligatorio o no es válido.");
                    valid = false;
                }
            });
        });
        return valid;
    }

    form.addEventListener("submit", (e) => {
        const fieldsToValidate = Array.from(form.querySelectorAll('.field'));
        if (!validateFields(fieldsToValidate)) {
            e.preventDefault();
        }
    });



    // Ubicacion cascading dropdowns
    document.querySelectorAll('select[name$="_municipio"]').forEach(municipioSelect => {
        const questionId = municipioSelect.name.split('_')[1];
        const ubicacionSelect = document.querySelector(`select[name="question_${questionId}_ubicacion"]`);
        const locInput = document.querySelector(`input[name="question_${questionId}_loc"]`);
        const zonaInput = document.querySelector(`input[name="question_${questionId}_zona"]`);

        municipioSelect.addEventListener('change', () => {
            const municipioId = municipioSelect.value;
            ubicacionSelect.innerHTML = '<option value="">Cargando...</option>';
            locInput.value = '';
            zonaInput.value = '';

            if (municipioId) {
                fetch(`{% url 'surveys:get_ubicaciones' %}?municipio_id=${municipioId}`)
                    .then(response => response.json())
                    .then(data => {
                        ubicacionSelect.innerHTML = '<option value="">Selecciona una ubicación</option>';
                        data.forEach(ubicacion => {
                            ubicacionSelect.innerHTML += `<option value="${ubicacion.id}">${ubicacion.nombre}</option>`;
                        });
                    });
            } else {
                ubicacionSelect.innerHTML = '<option value="">Selecciona un municipio primero</option>';
            }
        });

        ubicacionSelect.addEventListener('change', () => {
            const ubicacionId = ubicacionSelect.value;
            locInput.value = '';
            zonaInput.value = '';

            if (ubicacionId) {
                fetch(`{% url 'surveys:get_ubicacion_details' %}?ubicacion_id=${ubicacionId}`)
                    .then(response => response.json())
                    .then(data => {
                        locInput.value = data.loc;
                        zonaInput.value = data.zona;
                    });
            }
        });
    });

    // Add this inside the DOMContentLoaded listener
    document.querySelectorAll('.radio-options-inline, .checkbox-options-inline').forEach(container => {
        const inputs = container.querySelectorAll('input[type="radio"], input[type="checkbox"]');
        inputs.forEach(input => {
            input.addEventListener('change', () => {
                // For radio buttons, remove .selected from all in the group
                if (input.type === 'radio') {
                    const groupName = input.name;
                    document.querySelectorAll(`input[name="${groupName}"]`).forEach(radio => {
                        radio.parentElement.classList.remove('selected');
                    });
                }
                // Add or remove .selected based on checked state
                if (input.checked) {
                    input.parentElement.classList.add('selected');
                } else {
                    input.parentElement.classList.remove('selected');
                }
            });
            // Initial state
            if (input.checked) {
                input.parentElement.classList.add('selected');
            }
        });
    });

    // --- Dependency Logic ---
    const formContainer = document.querySelector('form');

    function updateDependentQuestions() {
        const allQuestions = document.querySelectorAll('.question-wrapper');
        const formData = new FormData(formContainer);
        
        const questionStates = {};
        for (const [name, value] of formData.entries()) {
            const match = name.match(/question_(\d+)/);
            if (match) {
                const qId = match[1];
                if (!questionStates[qId]) {
                    questionStates[qId] = [];
                }
                questionStates[qId].push(value);
            }
        }

        allQuestions.forEach(questionWrapper => {
            const dependsOnQuestion = questionWrapper.dataset.dependsOnQuestion;
            if (!dependsOnQuestion) return; // Skip if not a dependent question

            const dependsOnOption = questionWrapper.dataset.dependsOnOption;
            const dependsOnMin = questionWrapper.dataset.dependsOnValueMin;
            const dependsOnMax = questionWrapper.dataset.dependsOnValueMax;
            const parentState = questionStates[dependsOnQuestion];

            let isMet = false;

            // Check for option-based dependency
            if (dependsOnOption) {
                if (parentState && parentState.some(value => value.startsWith(dependsOnOption + '__') || value === dependsOnOption)) {
                    isMet = true;
                }
            }
            // Check for value-based dependency
            else if (dependsOnMin || dependsOnMax) {
                if (parentState && parentState.length > 0) {
                    const parentValue = parseFloat(parentState[0]);
                    if (!isNaN(parentValue)) {
                        const min = dependsOnMin ? parseFloat(dependsOnMin) : null;
                        const max = dependsOnMax ? parseFloat(dependsOnMax) : null;
                        
                        let minCondition = true;
                        let maxCondition = true;

                        if (min !== null) {
                            minCondition = parentValue >= min;
                        }
                        if (max !== null) {
                            maxCondition = parentValue <= max;
                        }
                        if (minCondition && maxCondition) {
                            isMet = true;
                        }
                    }
                }
            }

            if (isMet) {
                questionWrapper.style.display = '';
            } else {
                questionWrapper.style.display = 'none';
            }
        });
    }

    // Initial check on page load
    updateDependentQuestions();

        // --- "Other" option logic ---
    function handleOtherOption() {
        document.querySelectorAll('.question-wrapper[data-other-trigger]').forEach(wrapper => {
            const triggerCode = wrapper.dataset.otherTrigger;
            const otherTextWrapper = wrapper.querySelector('.other-text-wrapper');
            if (!triggerCode || !otherTextWrapper) return;

            const questionId = wrapper.dataset.questionId;
            const fieldElements = wrapper.querySelectorAll(
                `input[name="question_${questionId}"], select[name="question_${questionId}"]`
            );

            function checkOther() {
                let triggerSelected = false;

                fieldElements.forEach(element => {
                    if (element.tagName === 'SELECT') {
                        const selectedValue = element.value;
                        if (selectedValue.includes('__')) {
                            const code = selectedValue.split('__')[1];
                            if (code === triggerCode) {
                                triggerSelected = true;
                            }
                        }
                    } else if (element.type === 'radio' || element.type === 'checkbox') {
                        if (element.checked) {
                            const value = element.value;
                            if (value.includes('__')) {
                                const code = value.split('__')[1];
                                if (code === triggerCode) {
                                    triggerSelected = true;
                                }
                            }
                        }
                    }
                });

                if (triggerSelected) {
                    otherTextWrapper.style.display = 'block';
                } else {
                    otherTextWrapper.style.display = 'none';
                    otherTextWrapper.querySelector('input').value = ''; // Clear value when hidden
                }
            }

            fieldElements.forEach(element => {
                element.addEventListener('change', checkOther);
            });

            // Initial check
            checkOther();
        });
    }

    handleOtherOption();

    // Add event listener to the form
     if (formContainer) {
        formContainer.addEventListener('change', () => {
            updateDependentQuestions();
            handleOtherOption();
        });
    }

    // --- Client-side validation for min/max on number inputs ---
    document.querySelectorAll('input[type="number"][min], input[type="number"][max]').forEach(input => {
        input.addEventListener('input', () => {
            const value = parseFloat(input.value);
            const min = input.hasAttribute('min') ? parseFloat(input.getAttribute('min')) : null;
            const max = input.hasAttribute('max') ? parseFloat(input.getAttribute('max')) : null;
            const fieldWrapper = input.closest('.field');

            if (isNaN(value)) {
                clearFieldError(fieldWrapper);
                return;
            }

            let errorMessage = '';
            if (min !== null && value < min) {
                errorMessage = `El valor debe ser mayor o igual a ${min}.`;
            } else if (max !== null && value > max) {
                errorMessage = `El valor debe ser menor o igual a ${max}.`;
            }

            if (errorMessage) {
                setFieldError(fieldWrapper, errorMessage);
            } else {
                clearFieldError(fieldWrapper);
            }
        });
    });

});
</script>

{% endblock %}